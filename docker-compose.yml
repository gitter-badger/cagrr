version: '2'
services:
  #----------------------------------- Cassanra cluster
  cassandra1:
    build: ./docker/cassandra
    restart: "on-failure:100"
    networks:
      app:
        ipv4_address: 172.16.238.10
    environment:
      JVM_OPTS: "-Djava.rmi.server.hostname=172.16.238.10"
      LOCAL_JMX: "no"

  cassandra2:
    build: ./docker/cassandra
    restart: "on-failure:100"
    networks:
      app:
        ipv4_address: 172.16.238.11
    environment:
      CASSANDRA_SEEDS: "172.16.238.10"

  cassandra3:
    build: ./docker/cassandra
    restart: "on-failure:100"
    networks:
      app:
        ipv4_address: 172.16.238.12
    environment:
      CASSANDRA_SEEDS: "172.16.238.10"

  #----------------------------------------- Metrics
  # Graphite
  # Grafana
  graphite:
    image: nickstenning/graphite
    networks:
      app:
        ipv4_address: 172.16.238.4
      tools:
        ipv4_address: 172.16.237.4

  grafana:
    image: grafana/grafana
    networks:
      tools:
        ipv4_address: 172.16.237.7

  diamond:
    image: lesaux/diamond-containercollector
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc:/host_proc:ro
    environment:
      - GRAPHITE_HOST=graphite
      - DOCKER_HOSTNAME=cagrr-node1
      - INTERVAL=5
    networks:
      - tools
  #----------------------------------------- Logs
  # Logstash+logspout
  # Elasticsearch
  # Kibana

  elasticsearch:
    image: elasticsearch:5
    environment:
      ES_JAVA_OPTS: "-Xms512m -Xmx512m"
    networks:
      - tools

  logstash:
    image: logstash:5
    command: -f /opt/logstash/logstash.conf
    depends_on:
      - elasticsearch
    networks:
      - tools
    environment:
      LOGSPOUT: ignore
    volumes:
      - ./docker/logstash/:/opt/logstash/


  logspout:
    build: ./docker/logspout
    restart: "on-failure:100"
    environment:
      ROUTE_URIS: "logstash+tcp://logstash:5000"
      DEBUG: "true"
    depends_on:
      - logstash
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - tools


  kibana:
    image: kibana:5
    depends_on:
      - elasticsearch
    networks:
      tools:
        ipv4_address: 172.16.237.5

networks:
  tools:
    driver: bridge
    driver_opts:
      com.docker.network.enable_ipv6: "false"
    ipam:
      driver: default
      config:
      - subnet: 172.16.237.0/24
        gateway: 172.16.237.1
  app:
    driver: bridge
    driver_opts:
      com.docker.network.enable_ipv6: "false"
    ipam:
      driver: default
      config:
      - subnet: 172.16.238.0/24
        gateway: 172.16.238.1
